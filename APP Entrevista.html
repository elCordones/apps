<!DOCTYPE html>
<html lang="ca" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador d'Entrevistes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble-user {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .chat-bubble-ai {
            background-color: #4B5563; /* gray-600 */
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        .loader {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            border: 3px solid;
            border-color: #FFF #FFF transparent transparent;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Estil per als radio buttons personalitzats */
        .voice-label {
            display: inline-block;
            background-color: #374151; /* gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 2px solid transparent;
        }
        .voice-input:checked + .voice-label {
            background-color: #3B82F6; /* blue-500 */
            border-color: #60A5FA; /* blue-400 */
        }
        .voice-input {
            display: none;
        }
        /* Estils per a la finestra emergent de la imatge */
        #image-modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-full antialiased">

    <div id="app" class="flex flex-col h-full w-full max-w-3xl mx-auto p-4 md:p-6">
        
        <!-- Pantalla de configuració inicial -->
        <div id="character-setup" class="flex flex-col items-center justify-center h-full text-center">
            <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md">
                <h1 class="text-3xl font-bold mb-2 text-blue-300">Simulador d'Entrevistes</h1>
                <p class="text-gray-400 mb-6">Indica amb quin personatge i veu vols conversar.</p>
                <form id="character-form" class="flex flex-col gap-4">
                    <input type="text" id="character-name" placeholder="Ex: Sherlock Holmes, una astronauta..." class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required>
                    
                    <div class="flex justify-center gap-4 my-2">
                        <div>
                            <input type="radio" id="male-voice" name="voice-gender" value="male" class="voice-input" checked>
                            <label for="male-voice" class="voice-label">Veu Masculina</label>
                        </div>
                        <div>
                            <input type="radio" id="female-voice" name="voice-gender" value="female" class="voice-input">
                            <label for="female-voice" class="voice-label">Veu Femenina</label>
                        </div>
                    </div>

                    <button id="start-button" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">Començar Entrevista</button>
                </form>
                 <p id="setup-error" class="text-red-400 mt-4 text-sm hidden"></p>
            </div>
        </div>

        <!-- Pantalla de l'entrevista -->
        <div id="interview-screen" class="hidden flex-1 flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 border-b border-gray-700 bg-gray-800 rounded-t-2xl">
                <div>
                    <h2 class="text-xl font-bold text-blue-300">Entrevista amb:</h2>
                    <p id="interview-character-name" class="text-lg font-medium"></p>
                </div>
                <button id="change-character-btn" class="text-sm bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition duration-200">Canviar Personatge</button>
            </header>
            
            <div id="chat-container" class="flex-1 p-4 space-y-4 overflow-y-auto bg-gray-800/50">
                <!-- Els missatges s'afegiran aquí -->
            </div>

            <footer class="p-4 bg-gray-800 rounded-b-2xl">
                <form id="question-form" class="flex items-center gap-3">
                    <input type="text" id="question-input" placeholder="Fes la teva pregunta..." class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" autocomplete="off" required>
                    <button id="send-button" type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-full transition duration-200 flex items-center justify-center w-12 h-12">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
                 <p id="question-error" class="text-red-400 mt-2 text-sm text-center hidden"></p>
            </footer>
        </div>
    </div>

    <!-- Finestra emergent per a la imatge del personatge -->
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-gray-800 p-4 rounded-lg shadow-xl relative max-w-sm w-full text-center">
            <button id="close-modal-btn" class="absolute -top-2 -right-2 text-white bg-gray-700 rounded-full h-8 w-8 flex items-center justify-center text-xl hover:bg-red-500 transition-colors">&times;</button>
            <img id="character-image" src="" alt="Retrat del personatge" class="w-full h-auto rounded-md object-cover aspect-square">
            <p id="image-caption" class="mt-2 text-gray-300 font-medium"></p>
        </div>
    </div>


    <script>
        const characterSetup = document.getElementById('character-setup');
        const interviewScreen = document.getElementById('interview-screen');
        const characterForm = document.getElementById('character-form');
        const characterNameInput = document.getElementById('character-name');
        const startButton = document.getElementById('start-button');
        const interviewCharacterName = document.getElementById('interview-character-name');
        const changeCharacterBtn = document.getElementById('change-character-btn');
        const chatContainer = document.getElementById('chat-container');
        const questionForm = document.getElementById('question-form');
        const questionInput = document.getElementById('question-input');
        const sendButton = document.getElementById('send-button');
        const setupError = document.getElementById('setup-error');
        const questionError = document.getElementById('question-error');

        // Elements de la finestra emergent
        const imageModal = document.getElementById('image-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const characterImage = document.getElementById('character-image');
        const imageCaption = document.getElementById('image-caption');

        let character = '';
        let characterGender = 'male';
        let characterImageUrl = null;
        let conversationHistory = [];
        let isLoading = false;

        const API_KEY = ""; // S'injectarà en temps d'execució
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`;

        // --- Funcions de la finestra emergent ---
        function showImageModal() {
            if (characterImageUrl) {
                characterImage.src = characterImageUrl;
                imageCaption.textContent = character;
                imageModal.classList.remove('hidden');
                imageModal.classList.add('flex');
            }
        }

        function hideImageModal() {
            imageModal.classList.add('hidden');
            imageModal.classList.remove('flex');
            characterImage.src = '';
        }

        closeModalBtn.addEventListener('click', hideImageModal);
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                hideImageModal();
            }
        });


        // --- Funcions d'àudio ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            /* RIFF header */
            view.setUint32(0, 1380533830, false); // "RIFF"
            view.setUint32(4, 36 + dataSize, true);
            view.setUint32(8, 1463899717, false); // "WAVE"
            /* "fmt " sub-chunk */
            view.setUint32(12, 1718449184, false); // "fmt "
            view.setUint32(16, 16, true); // PCM chunk size
            view.setUint16(20, 1, true); // Linear PCM
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            /* "data" sub-chunk */
            view.setUint32(36, 1684108385, false); // "data"
            view.setUint32(40, dataSize, true);

            const pcm16 = new Int16Array(pcmData);
            const dataView = new Int16Array(buffer, 44);
            dataView.set(pcm16);

            return new Blob([view], { type: 'audio/wav' });
        }
        
        async function generateAndPlayAudio(text, buttonElement) {
            try {
                const voiceName = characterGender === 'female' ? 'Kore' : 'Charon'; // Veus predeterminades
                
                const payload = {
                    model: "gemini-2.5-flash-preview-tts",
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                           voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } }
                        }
                    }
                };

                const response = await fetch(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error de l'API de TTS: ${response.status}`);
                
                const result = await response.json();
                const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        hideImageModal();
                    };

                    buttonElement.disabled = false;
                    buttonElement.classList.remove('opacity-50', 'cursor-not-allowed');
                    buttonElement.onclick = () => {
                        showImageModal();
                        audio.play();
                    };
                } else {
                    throw new Error("No s'han rebut dades d'àudio vàlides.");
                }
            } catch (error) {
                console.error("Error en generar l'àudio:", error);
                buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            }
        }
        
        // --- Lògica principal de la interfície ---
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => { element.classList.add('hidden'); }, 4000);
        }

        function addMessage(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `chat-bubble ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            messageBubble.appendChild(textSpan);

            if (sender === 'ai') {
                const playButton = document.createElement('button');
                playButton.className = 'p-1 rounded-full hover:bg-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
                playButton.disabled = true;
                playButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play-circle"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>`;
                messageBubble.appendChild(playButton);
                generateAndPlayAudio(text, playButton);
            }
            
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function setLoading(loading) {
            isLoading = loading;
            sendButton.disabled = loading;
            questionInput.disabled = loading;
            sendButton.innerHTML = loading ? '<div class="loader"></div>' : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
        }
        
        // --- Noves funcions d'imatge ---
        async function generateCharacterImage(characterName) {
            const prompt = `Retrat fotorealista de ${characterName}, primer pla, il·luminació cinematogràfica, alta qualitat.`;
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            try {
                const response = await fetch(IMAGE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Error de l'API d'imatges: ${response.status}`);

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                if (base64Data) {
                    characterImageUrl = `data:image/png;base64,${base64Data}`;
                } else {
                    throw new Error("No s'ha rebut una imatge vàlida de l'API.");
                }
            } catch (error) {
                console.error("Error en generar la imatge:", error);
                const initials = characterName.split(' ').map(n => n[0]).join('').toUpperCase();
                characterImageUrl = `https://placehold.co/512x512/374151/E5E7EB?text=${encodeURIComponent(initials)}`;
                showError(setupError, "No s'ha pogut generar la imatge. S'utilitzarà un marcador.");
            }
        }


        async function getAIResponse() {
            setLoading(true);
            questionError.classList.add('hidden');

            const systemPrompt = `Ets un actor expert. La teva tasca és assumir el rol d'un personatge especificat per l'usuari i respondre preguntes com si estiguessis en una entrevista real i breu. **Rol Actual:** ${character}. **Regles:** 1. Encarna el personatge (personalitat, to, vocabulari). 2. Respostes concises (1-3 frases). 3. Mantén-te sempre en el personatge, no revelis que ets una IA. 4. Respon en l'idioma de l'última pregunta. 5. Projecta confiança. 6. Si el personatge és ambigu, demana context en la teva primera resposta.`;

            const payload = {
                contents: conversationHistory,
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await fetch(TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Error de l'API: ${response.statusText}`);
                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (aiText) {
                    addMessage('ai', aiText);
                    conversationHistory.push({ role: "model", parts: [{ text: aiText }] });
                } else {
                   throw new Error("No s'ha rebut una resposta de text vàlida.");
                }
            } catch (error) {
                console.error("Error en la crida a l'API de text:", error);
                showError(questionError, "Hi ha hagut un problema. Intenta-ho de nou.");
                if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
                    conversationHistory.pop();
                }
            } finally {
                setLoading(false);
            }
        }

        characterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const characterInput = characterNameInput.value.trim();
            if (characterInput) {
                startButton.disabled = true;
                startButton.innerHTML = '<div class="loader"></div> Generant personatge...';
                
                await generateCharacterImage(characterInput);

                character = characterInput;
                characterGender = document.querySelector('input[name="voice-gender"]:checked').value;
                interviewCharacterName.textContent = character;
                
                characterSetup.classList.add('hidden');
                interviewScreen.classList.remove('hidden');
                interviewScreen.classList.add('flex');

                const confirmationText = `Entès. Estic a punt per assumir el paper de ${character}.`;
                addMessage('ai', confirmationText);
                conversationHistory = [{ role: "model", parts: [{ text: confirmationText }] }];
                
                startButton.disabled = false;
                startButton.textContent = 'Començar Entrevista';

            } else {
                showError(setupError, "Si us plau, introdueix un nom de personatge.");
            }
        });

        questionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (isLoading) return;
            const question = questionInput.value.trim();
            if (question) {
                addMessage('user', question);
                conversationHistory.push({ role: "user", parts: [{ text: question }] });
                questionInput.value = '';
                getAIResponse();
            }
        });
        
        changeCharacterBtn.addEventListener('click', () => {
            character = '';
            characterImageUrl = null;
            conversationHistory = [];
            characterNameInput.value = '';
            chatContainer.innerHTML = '';
            
            interviewScreen.classList.add('hidden');
            interviewScreen.classList.remove('flex');
            characterSetup.classList.remove('hidden');
        });

    </script>
</body>
</html>

