<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Matem√†tic Educatiu</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Confetti for animations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Comic Neue for friendly kids look -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Comic Neue', cursive;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Animations */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s ease-in-out; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        @keyframes float {
            0% { transform: translateY(0px); opacity: 0; }
            10% { opacity: 0.8; }
            50% { transform: translateY(-10px); }
            90% { opacity: 0.8; }
            100% { transform: translateY(0px); opacity: 0; }
        }
        /* Adjusted float for smoother transitions when emojis change */
        .animate-float-fade { animation: float 4s ease-in-out infinite; }

        /* New Animation: Fly to Collection */
        @keyframes flyUp {
            0% { 
                transform: translate(0, 0) scale(1); 
                opacity: 1;
            }
            50% {
                transform: translate(0, -100px) scale(1.5);
                opacity: 1;
            }
            100% { 
                transform: translate(0, -300px) scale(0.2); 
                opacity: 0;
            }
        }
        .animate-fly-up {
            animation: flyUp 0.8s ease-in-out forwards;
            position: absolute; /* To detach from layout flow during flight */
            z-index: 50;
        }

        .bingo-cell {
            transition: all 0.3s ease;
        }
        .bingo-cell:active {
            transform: scale(0.95);
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B6B',
                        secondary: '#4ECDC4',
                        accent: '#FFE66D',
                        dark: '#2d3436',
                        light: '#f7f1e3',
                        warn: '#FFB74D' // Orange for max attempts reached
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- LICENSING & ATTRIBUTION ---
        const LICENSE_INFO = {
            author: "David Cordones",
            year: "2025",
            codeLicense: "AGPL v3",
            codeLink: "LICENSE.txt", 
            contentLicense: "CC BY-SA 4.0",
            contentLink: "https://creativecommons.org/licenses/by-sa/4.0/"
        };

        // --- EMOJI COLLECTION ---
        const REWARD_EMOJIS = [
            'ü¶Ñ', 'ü¶ñ', 'üöÄ', 'üçï', 'üéÆ', 'üåà', 'üê±', 'ü§ñ', 'üç¶', 
            'ü¶Å', 'üé∏', '‚öΩ', 'ü¶ã', 'üç™', 'üé®', 'üê∂', 'üéÅ', '‚≠ê',
            'üçé', 'üöó', 'üéà', 'üêº', 'üç©', 'üåç', 'üè∞', 'üçÑ', 'üê¢'
        ];

        // --- I18N CONFIGURATION ---
        const translations = {
            ca: {
                title: "Bingo Matem√†tic!",
                setup_title: "Configuraci√≥ del Jugador",
                name_label: "Com et dius?",
                age_label: "Quants anys tens?",
                ops_label: "Qu√® vols practicar?",
                ops_add: "Sumes (+)",
                ops_sub: "Restes (-)",
                ops_mul: "Multiplicacions (√ó)",
                ops_div: "Divisions (√∑)",
                start_btn: "COMEN√áAR JOC! üöÄ",
                score: "Punts",
                attempts: "Intents",
                collection: "Col¬∑lecci√≥",
                question: "Resol per guanyar:",
                bingo_shout: "BINGO!",
                congrats: "Felicitats",
                download: "Descarregar Resultats üì•",
                restart: "Tornar a jugar üîÑ",
                music: "M√∫sica",
                theme_light: "Clar",
                theme_dark: "Fosc",
                theme_auto: "Auto",
                err_select_ops: "Selecciona almenys una operaci√≥!",
                err_enter_name: "Escriu el teu nom!",
                game_over: "Joc Finalitzat",
                solved: "Resolt",
                report_title: "Informe de Resultats",
                report_details: "Detalls per operaci√≥",
                max_attempts_reached: "Oh no! üòÖ Has esgotat els 3 intents. La resposta era:",
                failed_status: "No superat"
            },
            es: {
                title: "Bingo Matem√°tico!",
                setup_title: "Configuraci√≥n del Jugador",
                name_label: "¬øC√≥mo te llamas?",
                age_label: "¬øCu√°ntos a√±os tienes?",
                ops_label: "¬øQu√© quieres practicar?",
                ops_add: "Sumas (+)",
                ops_sub: "Restas (-)",
                ops_mul: "Multiplicaciones (√ó)",
                ops_div: "Divisiones (√∑)",
                start_btn: "¬°EMPEZAR JUEGO! üöÄ",
                score: "Puntos",
                attempts: "Intentos",
                collection: "Colecci√≥n",
                question: "Resuelve para ganar:",
                bingo_shout: "¬°BINGO!",
                congrats: "Felicidades",
                download: "Descargar Resultados üì•",
                restart: "Volver a jugar üîÑ",
                music: "M√∫sica",
                theme_light: "Claro",
                theme_dark: "Oscuro",
                theme_auto: "Auto",
                err_select_ops: "¬°Selecciona al menos una operaci√≥n!",
                err_enter_name: "¬°Escribe tu nombre!",
                game_over: "Juego Terminado",
                solved: "Resuelto",
                report_title: "Informe de Resultados",
                report_details: "Detalles por operaci√≥n",
                max_attempts_reached: "¬°Oh no! üòÖ Has agotado los 3 intentos. La respuesta era:",
                failed_status: "No superado"
            },
            en: {
                title: "Math Bingo!",
                setup_title: "Player Setup",
                name_label: "What's your name?",
                age_label: "How old are you?",
                ops_label: "What to practice?",
                ops_add: "Addition (+)",
                ops_sub: "Subtraction (-)",
                ops_mul: "Multiplication (√ó)",
                ops_div: "Division (√∑)",
                start_btn: "START GAME! üöÄ",
                score: "Score",
                attempts: "Attempts",
                collection: "Collection",
                question: "Solve to win:",
                bingo_shout: "BINGO!",
                congrats: "Congratulations",
                download: "Download Results üì•",
                restart: "Play Again üîÑ",
                music: "Music",
                theme_light: "Light",
                theme_dark: "Dark",
                theme_auto: "Auto",
                err_select_ops: "Select at least one operation!",
                err_enter_name: "Enter your name!",
                game_over: "Game Over",
                solved: "Solved",
                report_title: "Results Report",
                report_details: "Details per operation",
                max_attempts_reached: "Oh no! üòÖ You used all 3 attempts. The answer was:",
                failed_status: "Failed"
            },
            gl: {
                title: "Bingo Matem√°tico!",
                setup_title: "Configuraci√≥n do Xogador",
                name_label: "Como te chamas?",
                age_label: "Cantos anos tes?",
                ops_label: "Que queres practicar?",
                ops_add: "Sumas (+)",
                ops_sub: "Restas (-)",
                ops_mul: "Multiplicaci√≥ns (√ó)",
                ops_div: "Divisi√≥ns (√∑)",
                start_btn: "COMEZAR XOGO! üöÄ",
                score: "Puntos",
                attempts: "Intentos",
                collection: "Colecci√≥n",
                question: "Resolve para ga√±ar:",
                bingo_shout: "BINGO!",
                congrats: "Parab√©ns",
                download: "Descargar Resultados üì•",
                restart: "Xogar de novo üîÑ",
                music: "M√∫sica",
                theme_light: "Claro",
                theme_dark: "Escuro",
                theme_auto: "Auto",
                err_select_ops: "Selecciona polo menos unha operaci√≥n!",
                err_enter_name: "Escribe o teu nome!",
                game_over: "Xogo Rematado",
                solved: "Resolto",
                report_title: "Informe de Resultados",
                report_details: "Detalles por operaci√≥n",
                max_attempts_reached: "Vaya! üòÖ Esgotaches os 3 intentos. A resposta era:",
                failed_status: "Non superado"
            },
            eu: {
                title: "Matematika Bingoa!",
                setup_title: "Jokalariaren Konfigurazioa",
                name_label: "Nola duzu izena?",
                age_label: "Zenbat urte dituzu?",
                ops_label: "Zer praktikatu nahi duzu?",
                ops_add: "Batuketak (+)",
                ops_sub: "Kenketak (-)",
                ops_mul: "Biderketak (√ó)",
                ops_div: "Zatiketak (√∑)",
                start_btn: "HASI JOKOA! üöÄ",
                score: "Puntuak",
                attempts: "Saiakerak",
                collection: "Bilduma",
                question: "Ebatzi irabazteko:",
                bingo_shout: "BINGO!",
                congrats: "Zorionak",
                download: "Emaitzak Deskargatu üì•",
                restart: "Berriro jokatu üîÑ",
                music: "Musika",
                theme_light: "Argia",
                theme_dark: "Iluna",
                theme_auto: "Auto",
                err_select_ops: "Aukeratu gutxienez eragiketa bat!",
                err_enter_name: "Idatzi zure izena!",
                game_over: "Jokoa Amaitu da",
                solved: "Ebatzi da",
                report_title: "Emaitzen Txostena",
                report_details: "Eragiketa bakoitzeko xehetasunak",
                max_attempts_reached: "Ai ene! üòÖ 3 saiakerak agortu dituzu. Erantzuna hau zen:",
                failed_status: "Ez da gainditu"
            }
        };

        // --- AUDIO ENGINE ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } else if (type === 'pop') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            } else if (type === 'fail') { 
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } else if (type === 'win') {
                const now = ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g);
                    g.connect(ctx.destination);
                    o.type = 'triangle';
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.1, now + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.5);
                    o.start(now + i*0.1);
                    o.stop(now + i*0.1 + 0.5);
                });
            }
        };

        // --- MATH GENERATOR LOGIC ---
        const generateLevel = (age, selectedOps) => {
            let maxNum = 10;
            if (age >= 6 && age <= 8) maxNum = 20;
            if (age > 8) maxNum = 50;
            if (age > 10) maxNum = 100;

            const pairs = [];
            const usedAnswers = new Set();
            
            const shuffledEmojis = [...REWARD_EMOJIS].sort(() => Math.random() - 0.5);

            while(pairs.length < 9) {
                const opType = selectedOps[Math.floor(Math.random() * selectedOps.length)];
                let q, a, num1, num2;

                switch(opType) {
                    case 'add':
                        num1 = Math.floor(Math.random() * maxNum) + 1;
                        num2 = Math.floor(Math.random() * maxNum) + 1;
                        a = num1 + num2;
                        q = `${num1} + ${num2}`;
                        break;
                    case 'sub':
                        num1 = Math.floor(Math.random() * maxNum) + 1;
                        num2 = Math.floor(Math.random() * (num1)) + 1; 
                        a = num1 - num2;
                        q = `${num1} - ${num2}`;
                        break;
                    case 'mul':
                        const maxFactor = age > 8 ? 9 : 5;
                        num1 = Math.floor(Math.random() * maxFactor) + 1;
                        num2 = Math.floor(Math.random() * maxFactor) + 1;
                        a = num1 * num2;
                        q = `${num1} √ó ${num2}`;
                        break;
                    case 'div':
                        const maxDivisor = age > 8 ? 9 : 5;
                        num2 = Math.floor(Math.random() * maxDivisor) + 2; 
                        a = Math.floor(Math.random() * 10) + 1; 
                        num1 = num2 * a;
                        q = `${num1} √∑ ${num2}`;
                        break;
                }

                if (!usedAnswers.has(a)) {
                    usedAnswers.add(a);
                    pairs.push({ 
                        id: pairs.length, 
                        question: q, 
                        answer: a, 
                        status: 'pending',
                        emoji: shuffledEmojis[pairs.length] 
                    }); 
                }
            }
            return pairs;
        };

        // --- COMPONENTS ---

        function App() {
            // Global State
            const [lang, setLang] = useState('ca');
            const [theme, setTheme] = useState('auto');
            const [gameState, setGameState] = useState('setup'); 
            const [userData, setUserData] = useState({ name: '', age: 7, ops: ['add'] });
            
            // Game State
            const [gridData, setGridData] = useState([]);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [shuffledQuestions, setShuffledQuestions] = useState([]);
            const [score, setScore] = useState(0);
            const [isPlayingMusic, setIsPlayingMusic] = useState(false);

            // Background Emojis State
            const [bgEmojis, setBgEmojis] = useState(['ü¶Å', 'üöÄ', '‚≠ê', 'üéà']);

            // New: Tracking Attempts & Collection
            const [currentAttempts, setCurrentAttempts] = useState(0);
            const [attemptHistory, setAttemptHistory] = useState([]);
            const [collectedItems, setCollectedItems] = useState([]); 
            const [flyingEmoji, setFlyingEmoji] = useState(null); 

            const musicRef = useRef(null);
            const MAX_ATTEMPTS = 3;

            useEffect(() => {
                const root = window.document.documentElement;
                const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
            }, [theme]);

            // Background Emoji Rotator
            useEffect(() => {
                const interval = setInterval(() => {
                    const randomEmojis = [];
                    for(let i=0; i<4; i++) {
                        randomEmojis.push(REWARD_EMOJIS[Math.floor(Math.random() * REWARD_EMOJIS.length)]);
                    }
                    setBgEmojis(randomEmojis);
                }, 4000); // Change every 4 seconds
                return () => clearInterval(interval);
            }, []);

            const BG_MUSIC_URL = "https://cdn.pixabay.com/download/audio/2022/03/24/audio_343272f280.mp3?filename=happy-logo-17366.mp3"; 

            const toggleMusic = () => {
                if (isPlayingMusic) {
                    musicRef.current.pause();
                } else {
                    musicRef.current.play().catch(e => console.log("Audio play blocked", e));
                }
                setIsPlayingMusic(!isPlayingMusic);
            };

            const startGame = (data) => {
                if (!data.name) {
                    alert(translations[lang].err_enter_name);
                    return;
                }
                if (data.ops.length === 0) {
                    alert(translations[lang].err_select_ops);
                    return;
                }

                setUserData(data);
                const pairs = generateLevel(parseInt(data.age), data.ops);
                
                const grid = [...pairs].sort(() => Math.random() - 0.5);
                setGridData(grid);

                const questions = [...pairs].sort(() => Math.random() - 0.5);
                setShuffledQuestions(questions);
                
                setCurrentQuestionIndex(0);
                setScore(0);
                setCurrentAttempts(0);
                setAttemptHistory([]);
                setCollectedItems([]);
                setGameState('playing');
                
                if(isPlayingMusic) musicRef.current.play().catch(()=>{});
            };

            const handleAnswerClick = (cellId, cellAnswer) => {
                if(flyingEmoji) return;

                const currentQ = shuffledQuestions[currentQuestionIndex];
                const t = translations[lang];

                if (cellAnswer === currentQ.answer) {
                    playSound('correct');
                    const finalAttempts = currentAttempts + 1;
                    setFlyingEmoji(currentQ.emoji);

                    setGridData(prev => prev.map(cell => 
                        cell.id === cellId ? { ...cell, status: 'correct' } : cell
                    ));

                    setTimeout(() => {
                        setCollectedItems(prev => [...prev, currentQ.emoji]);
                        playSound('pop');
                        setFlyingEmoji(null);
                        
                        setAttemptHistory(prev => [
                            ...prev,
                            { 
                                question: currentQ.question, 
                                answer: currentQ.answer, 
                                attempts: finalAttempts,
                                status: 'success'
                            }
                        ]);

                        const pointsEarned = Math.max(10, 100 - ((finalAttempts - 1) * 20));
                        setScore(s => s + pointsEarned);

                        nextTurn();
                    }, 800);

                } else {
                    const newAttempts = currentAttempts + 1;
                    setCurrentAttempts(newAttempts);

                    if (newAttempts >= MAX_ATTEMPTS) {
                        playSound('fail');
                        alert(`${t.max_attempts_reached} ${currentQ.answer}`);

                        setAttemptHistory(prev => [
                            ...prev,
                            { 
                                question: currentQ.question, 
                                answer: currentQ.answer, 
                                attempts: MAX_ATTEMPTS,
                                status: 'failed'
                            }
                        ]);

                        setGridData(prev => prev.map(cell => 
                            cell.answer === currentQ.answer ? { ...cell, status: 'assisted' } : cell
                        ));
                        
                        nextTurn();

                    } else {
                        playSound('wrong');
                    }
                }
            };

            const nextTurn = () => {
                const newSolvedCount = currentQuestionIndex + 1;
                
                if (newSolvedCount >= 9) {
                    playSound('win');
                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    setGameState('win');
                } else {
                    setCurrentQuestionIndex(prev => prev + 1);
                    setCurrentAttempts(0); 
                }
            };

            const downloadResults = () => {
                const t = translations[lang];
                
                let detailsText = attemptHistory.map(item => {
                    const statusTxt = item.status === 'success' 
                        ? `${item.attempts} ${item.attempts === 1 ? 'intent' : 'intents'}` 
                        : `${t.failed_status} (${item.attempts} intents)`;
                    return `   ‚Ä¢ ${item.question} = ${item.answer} [${statusTxt}]`;
                }).join('\n');

                const collectionTxt = collectedItems.join(' ');

                const text = `
üéì ${t.title} - ${t.report_title}
üìÖ ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}

üë§ ${t.setup_title}:
   - Nom: ${userData.name}
   - Edat: ${userData.age}

üèÜ ${t.score}: ${score} / 900 (Max)
üéí ${t.collection}: ${collectionTxt}
‚úÖ ${t.solved}: 9/9

üìù ${t.report_details}:
${detailsText}
`.trim();
                
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Bingo_${userData.name}_Resultats.txt`;
                a.click();
            };

            const t = translations[lang];

            return (
                <div className="flex flex-col min-h-screen">
                    <audio ref={musicRef} src={BG_MUSIC_URL} loop />
                    
                    {/* Header */}
                    <header className="p-4 bg-white dark:bg-gray-800 shadow-md flex justify-between items-center z-10 relative">
                        <div className="flex items-center gap-2">
                             <i className="fa-solid fa-calculator text-primary text-2xl animate-bounce"></i>
                             <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary hidden md:block">{t.title}</h1>
                        </div>
                        
                        {/* Collection Sack Display (Visible during game) */}
                        {gameState === 'playing' && (
                            <div className="absolute left-1/2 transform -translate-x-1/2 flex flex-col items-center">
                                <div className="text-xs font-bold text-gray-400 mb-1">{t.collection}</div>
                                <div className="flex gap-1 bg-gray-100 dark:bg-gray-700 p-2 rounded-full shadow-inner min-w-[150px] justify-center h-10 items-center overflow-hidden">
                                    {collectedItems.map((emoji, i) => (
                                        <span key={i} className="text-lg animate-pop">{emoji}</span>
                                    ))}
                                    {[...Array(9 - collectedItems.length)].map((_, i) => (
                                        <div key={`empty-${i}`} className="w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600"></div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="flex gap-2 text-sm">
                            <button onClick={toggleMusic} className="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                {isPlayingMusic ? <i className="fa-solid fa-volume-high"></i> : <i className="fa-solid fa-volume-xmark"></i>}
                            </button>
                            <select value={lang} onChange={(e) => setLang(e.target.value)} className="p-1 rounded border dark:bg-gray-700 dark:border-gray-600">
                                <option value="ca">CA</option>
                                <option value="es">ES</option>
                                <option value="en">EN</option>
                                <option value="gl">GL</option>
                                <option value="eu">EU</option>
                            </select>
                            <select value={theme} onChange={(e) => setTheme(e.target.value)} className="p-1 rounded border dark:bg-gray-700 dark:border-gray-600">
                                <option value="light">‚òÄÔ∏è</option>
                                <option value="dark">üåô</option>
                                <option value="auto">‚öôÔ∏è</option>
                            </select>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-grow flex items-center justify-center p-4 relative overflow-hidden">
                        
                        {/* Dynamic Background Emojis */}
                        <div className="absolute inset-0 pointer-events-none opacity-10 dark:opacity-5 transition-all duration-1000">
                            {/* We use keys to force re-render animation if needed, or rely on CSS transition */}
                            {/* FIX: Append index to key to ensure uniqueness even if the emoji string is identical */}
                            <div className="absolute top-10 left-10 text-6xl animate-float-fade" key={`${bgEmojis[0]}-0`}>{bgEmojis[0]}</div>
                            <div className="absolute bottom-10 right-10 text-6xl animate-float-fade" style={{animationDelay: '1s'}} key={`${bgEmojis[1]}-1`}>{bgEmojis[1]}</div>
                            <div className="absolute top-1/2 left-5 text-4xl animate-float-fade" style={{animationDelay: '0.5s'}} key={`${bgEmojis[2]}-2`}>{bgEmojis[2]}</div>
                            <div className="absolute top-20 right-20 text-5xl animate-float-fade" style={{animationDelay: '1.5s'}} key={`${bgEmojis[3]}-3`}>{bgEmojis[3]}</div>
                        </div>

                        {gameState === 'setup' && (
                            <SetupScreen t={t} onStart={startGame} />
                        )}

                        {gameState === 'playing' && (
                            <GameScreen 
                                t={t} 
                                gridData={gridData} 
                                currentQuestion={shuffledQuestions[currentQuestionIndex]} 
                                onAnswer={handleAnswerClick}
                                score={score}
                                attempts={currentAttempts}
                                flyingEmoji={flyingEmoji}
                            />
                        )}

                        {gameState === 'win' && (
                            <WinScreen 
                                t={t} 
                                name={userData.name} 
                                score={score} 
                                collectedItems={collectedItems}
                                onDownload={downloadResults} 
                                onRestart={() => setGameState('setup')} 
                            />
                        )}
                    </main>

                    {/* Footer */}
                    <Footer />
                </div>
            );
        }

        const SetupScreen = ({ t, onStart }) => {
            const [name, setName] = useState('');
            const [age, setAge] = useState(7);
            const [ops, setOps] = useState(['add']);

            const toggleOp = (op) => {
                if (ops.includes(op)) {
                    if (ops.length > 1) setOps(ops.filter(o => o !== op));
                } else {
                    setOps([...ops, op]);
                }
            };

            return (
                <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md z-10 animate-pop border-4 border-secondary">
                    <h2 className="text-2xl font-bold mb-6 text-center text-primary">{t.setup_title}</h2>
                    
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold mb-1">{t.name_label}</label>
                            <input 
                                type="text" 
                                value={name} 
                                onChange={(e) => setName(e.target.value)}
                                className="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-secondary focus:outline-none dark:bg-gray-700 dark:border-gray-600"
                                placeholder="Nom..."
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-bold mb-1">{t.age_label}: {age}</label>
                            <input 
                                type="range" 
                                min="4" max="12" 
                                value={age} 
                                onChange={(e) => setAge(e.target.value)}
                                className="w-full accent-secondary"
                            />
                            <div className="flex justify-between text-xs text-gray-400">
                                <span>4</span><span>12</span>
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-bold mb-2">{t.ops_label}</label>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => toggleOp('add')} className={`p-2 rounded-lg transition ${ops.includes('add') ? 'bg-green-400 text-white font-bold transform scale-105' : 'bg-gray-200 dark:bg-gray-700'}`}>{t.ops_add}</button>
                                <button onClick={() => toggleOp('sub')} className={`p-2 rounded-lg transition ${ops.includes('sub') ? 'bg-blue-400 text-white font-bold transform scale-105' : 'bg-gray-200 dark:bg-gray-700'}`}>{t.ops_sub}</button>
                                <button onClick={() => toggleOp('mul')} className={`p-2 rounded-lg transition ${ops.includes('mul') ? 'bg-purple-400 text-white font-bold transform scale-105' : 'bg-gray-200 dark:bg-gray-700'}`}>{t.ops_mul}</button>
                                <button onClick={() => toggleOp('div')} className={`p-2 rounded-lg transition ${ops.includes('div') ? 'bg-orange-400 text-white font-bold transform scale-105' : 'bg-gray-200 dark:bg-gray-700'}`}>{t.ops_div}</button>
                            </div>
                        </div>

                        <button 
                            onClick={() => onStart({name, age, ops})}
                            className="w-full py-4 mt-4 bg-primary text-white text-xl font-bold rounded-xl shadow-lg hover:bg-red-500 transform hover:-translate-y-1 transition"
                        >
                            {t.start_btn}
                        </button>
                    </div>
                </div>
            );
        };

        const GameScreen = ({ t, gridData, currentQuestion, onAnswer, score, attempts, flyingEmoji }) => {
            const getCellStyle = (status) => {
                if (status === 'correct') return 'bg-green-500 text-white opacity-50 cursor-default scale-95 ring-4 ring-green-300';
                if (status === 'assisted') return 'bg-warn text-white opacity-60 cursor-default scale-95 ring-4 ring-orange-300'; 
                return 'bg-white dark:bg-gray-700 hover:bg-yellow-100 dark:hover:bg-gray-600 text-gray-700 dark:text-white';
            };

            const getIcon = (status) => {
                if (status === 'correct') return '‚úÖ';
                if (status === 'assisted') return '‚ö†Ô∏è';
                return null;
            };

            return (
                <div className="flex flex-col items-center w-full max-w-lg z-10">
                    
                    {/* Score Board */}
                    <div className="flex gap-4 mb-6">
                        <div className="bg-white dark:bg-gray-800 px-6 py-2 rounded-full shadow-lg flex gap-2 text-xl font-bold text-secondary">
                            <span>‚≠ê {score}</span>
                        </div>
                        <div className="bg-white dark:bg-gray-800 px-6 py-2 rounded-full shadow-lg flex gap-2 text-xl font-bold text-primary">
                            <span>üéØ {t.attempts}: {attempts} / 3</span>
                        </div>
                    </div>

                    {/* Bingo Grid */}
                    <div className="grid grid-cols-3 gap-3 w-full bg-secondary p-4 rounded-2xl shadow-2xl">
                        {gridData.map((cell) => (
                            <button 
                                key={cell.id}
                                onClick={() => (cell.status !== 'correct' && cell.status !== 'assisted') && onAnswer(cell.id, cell.answer)}
                                disabled={cell.status === 'correct' || cell.status === 'assisted'}
                                className={`
                                    bingo-cell aspect-square rounded-xl text-3xl font-bold flex items-center justify-center shadow-md
                                    ${getCellStyle(cell.status)}
                                `}
                            >
                                {getIcon(cell.status) || cell.answer}
                            </button>
                        ))}
                    </div>

                    {/* Question Card */}
                    <div className="mt-8 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl w-full text-center border-b-8 border-primary animate-pop relative">
                        <p className="text-gray-500 dark:text-gray-400 uppercase tracking-widest text-xs font-bold mb-2">{t.question}</p>
                        
                        <div className="flex justify-center items-center gap-4">
                            <div className="text-6xl font-black text-gray-800 dark:text-white font-mono">
                                {currentQuestion ? currentQuestion.question : '...'}
                            </div>
                            
                            {/* Emoji Target Display */}
                            <div className="text-5xl relative">
                                {/* Static Emoji (fades out when flying starts) */}
                                <span style={{opacity: flyingEmoji ? 0 : 1, transition: 'opacity 0.2s'}}>
                                    {currentQuestion?.emoji || '‚ùì'}
                                </span>

                                {/* Flying Emoji (Animation) */}
                                {flyingEmoji && (
                                    <span className="animate-fly-up absolute top-0 left-0">
                                        {flyingEmoji}
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const WinScreen = ({ t, name, score, collectedItems, onDownload, onRestart }) => {
            return (
                <div className="text-center z-10 animate-pop w-full max-w-2xl px-4">
                    <h1 className="text-6xl mb-4">üèÜ</h1>
                    <h2 className="text-4xl font-bold text-primary mb-2">{t.bingo_shout}</h2>
                    <p className="text-2xl text-gray-600 dark:text-gray-300 mb-8">{t.congrats}, <span className="text-secondary font-bold">{name}</span>!</p>
                    
                    <div className="grid grid-cols-2 gap-4 mb-8">
                        <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                            <div className="text-sm text-gray-500 uppercase font-bold">{t.score}</div>
                            <div className="text-4xl font-bold">‚≠ê {score}</div>
                        </div>
                        <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                            <div className="text-sm text-gray-500 uppercase font-bold">{t.collection}</div>
                            <div className="text-2xl mt-1 tracking-widest">
                                {collectedItems.map(i => i).join(' ')}
                            </div>
                        </div>
                    </div>

                    <div className="flex flex-col gap-3 justify-center">
                        <button onClick={onDownload} className="bg-secondary text-white px-8 py-3 rounded-lg font-bold shadow hover:bg-teal-500 transition">
                            {t.download}
                        </button>
                        <button onClick={onRestart} className="text-gray-500 hover:text-gray-800 dark:hover:text-white underline">
                            {t.restart}
                        </button>
                    </div>
                </div>
            );
        };

        const Footer = () => (
            <footer className="text-center p-4 text-xs text-gray-400 border-t dark:border-gray-800 bg-white dark:bg-gray-900 mt-auto">
                <p>¬© David Cordones</p>
                <p>
                    Licencia del c√≥digo: <a href="#" className="underline">AGPL v3</a> (LICENSE.txt) ¬∑ 
                    Contenido: <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" className="underline">CC BY-SA 4.0</a>
                </p>
            </footer>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>